https://www.youtube.com/watch?v=XF0GBIJFWjc

この解説では、n8nで高度なAIエージェントのワークフローを構築する方法を説明します。特に、エージェントが複数の種類の情報を出力する「アドバンスト出力」という概念と、それを利用して動的にワークフローの経路を決定する方法に焦点を当てます。

---

## 1. アドバンスト出力とは？

従来のAIエージェントは、単一のテキスト応答を生成するのが一般的でした。しかし、「アドバンスト出力」を使用すると、エージェントは単一の出力ノードを通じて、**複数の異なる情報（メタデータ）**を含む構造化されたデータ（JSON形式）を生成できます。これにより、顧客への応答だけでなく、その応答の根拠、信頼度、あるいは後続のワークフローで利用する追加情報などを一括して取得できるようになります。

例えば、顧客サポートエージェントが「注文はどこ？」という質問を受けた場合、アドバンスト出力では以下のような情報を出力できます。

- **応答:** "ご注文は明日配達されます。"
- **推論ステップ:** 注文追跡APIへの問い合わせ、配達予定日の取得など。
- **信頼度:** 応答の正確性に対するエージェント自身の評価（例: 0.9）。
- **その他のメタデータ:** 注文ID、顧客IDなど。

---

## 2. アドバンスト出力を利用したワークフローの例

この概念を理解するために、2つの異なるワークフローを例に挙げます。

### 2.1 自己修正型エージェント

このワークフローでは、エージェントがユーザーからの入力を受け取り、応答を生成します。その応答には、**「正解性チェック」のメタデータ**が含まれます。

1. **入力受付:** エンドユーザーから質問を受け取ります。
2. **応答生成:** AIエージェントが応答を生成し、同時に応答の「信頼度」を評価します。
3. **信頼度チェック:**
    - **信頼度が高い場合（例: 0.7以上）:** 応答は直接顧客に送信され、会話が続行されます。
    - **信頼度が低い場合（例: 0.7未満）:** エージェントは、応答を修正するために追加の情報を取得するか、別のAIエージェントに処理を委ねるように促されます。これにより、より正確な応答を生成するための「ループ」が発生します。

### 2.2 リサーチエージェント

このワークフローでは、エージェントが顧客からリサーチプロジェクトに必要な情報を収集します。

1. **入力受付:** 顧客からリサーチの要望を受け取ります。
2. **情報確認:** エージェントは、リサーチプランを生成するのに十分な情報があるかを判断します。この判断は、出力される「proceed（続行可否）」メタデータに基づいて行われます。
3. **情報不足の場合:** 顧客にさらに質問し、必要な情報を収集します。
4. **情報十分の場合:** エージェントは、メタデータとして「リサーチプラン」を生成します。
5. **リサーチプラン実行:** 生成されたリサーチプランに基づいて、異なるリサーチエージェント（例: リサーチエージェントAは米国、リサーチエージェントBはオーストラリアを担当）がそれぞれリサーチを実行します。
6. **結果の集約:** 各リサーチエージェントからの結果をまとめ、要約して顧客に提示します。

これらのワークフローのポイントは、エージェントが生成するメタデータに基づいて、**動的に異なる経路を選択できる**点です。

---

## 3. ワークフロー構築の主要な要素

### 3.1 AIエージェントのシステムプロンプト設定

JSON形式でアドバンスト出力を得るためには、AIエージェントの**システムメッセージ**で出力形式を明確に定義する必要があります。これは、AIエージェントに「どのようなキー（静的な要素）とバリュー（動的に生成される要素）を持つJSONオブジェクトを出力してほしいか」を指示する部分です。

#### JSON出力の定義例

JSON

```
{
  "response": "顧客への応答",
  "logic": "回答に至る思考ステップ",
  "confidence": "回答の正確性に対する自信のレベル（0.0～1.0）"
}
```

- `response`: ユーザーへの直接的な回答。
- `logic`: エージェントが回答を導き出した論理的なステップ。
- `confidence`: エージェント自身が回答の正確性を評価した数値（例: 0.8）。

このJSON構造をシステムプロンプトに含めることで、AIエージェントは指定された形式で情報を出力するようになります。最後のキーにはカンマ（`,`）は不要です。

### 3.2 コードノードによるJSON出力のパース

AIエージェントから出力されるJSONデータは、n8nの次のステップで利用するためにパース（解析）する必要があります。このパースには**コードノード**を使用するのが最も信頼性の高い方法です。

AIエージェントからの出力は通常、`output`変数にラップされた文字列として提供されます。これをJavaScriptなどのコードでJSONオブジェクトに変換し、必要な情報を個別の変数として抽出します。

#### コードノードのJavaScript例

JavaScript

```
// AIエージェントからの出力を取得
const agentOutput = $('AI Agent').item.json.output;

// JSON文字列をパース
// AIエージェントの出力形式によっては、JSON.parseを二重に適用する必要がある場合があります。
let parsedOutput;
try {
  parsedOutput = JSON.parse(agentOutput);
} catch (e) {
  // 必要に応じて、異なるパース方法を試す
  parsedOutput = JSON.parse(JSON.parse(agentOutput));
}

// 抽出した変数を次のノードで利用可能にする
return [
  {
    json: {
      response: parsedOutput.response,
      logic: parsedOutput.logic,
      confidence: parsedOutput.confidence
    }
  }
];
```

このコードノードにより、`response`、`logic`、`confidence`といった個別の変数が次のノードでアクセスできるようになります。

### 3.3 ifノードによる条件分岐

パースされたメタデータに基づいて、ワークフローの経路を動的に決定するために**ifノード**を使用します。

例えば、自己修正型エージェントの例では、コードノードで抽出した`confidence`変数の値が0.7よりも大きいかどうかをifノードでチェックします。

- **True（真）の経路:** `confidence`が0.7より大きい場合、応答はユーザーに直接送信されます。
- **False（偽）の経路:** `confidence`が0.7未満の場合、エージェントは応答を修正するための追加の処理（例: 別のAIエージェントへの再問い合わせ、情報収集のためのプロンプト）に進みます。

#### ifノードの設定例

- **条件:** `{{ $('Code').item.json.confidence > 0.7 }}`

### 3.4 switchノードによる複数経路の選択（発展）

ifノードは2つの経路（True/False）に限定されますが、より多くの経路が必要な場合は**switchノード**を使用できます。switchノードは、特定の変数の値に基づいて、複数の異なる出力経路を設定できます。これは、リサーチエージェントのように、出力されるメタデータが複数の異なるアクションをトリガーする場合に特に有用です。

---

## 4. ワークフロー構築の具体的なステップ

1. **AI Agentノードの追加と設定:**
    
    - システムメッセージに、上記のJSON出力形式を含めてプロンプトを設定します。
    - 「Require Specific Output Format」オプションはオフにしておくことを推奨します。コードノードで柔軟にパースする方が確実です。
2. **Codeノードの追加と設定:**
    
    - AI Agentノードの出力を受け取るように接続します。
    - 上記のJavaScriptコードを貼り付け、AIエージェントの出力形式に合わせて適宜調整します。
    - テスト実行を行い、JSONが正しくパースされ、期待する変数（`response`, `logic`, `confidence`など）がCodeノードの出力として表示されることを確認します。
3. **Ifノード（またはSwitchノード）の追加と設定:**
    
    - Codeノードの出力を受け取るように接続します。
    - Codeノードでパースされたメタデータ（例: `confidence`、`proceed`）を条件として設定します。
    - True/False（またはSwitchの各ケース）の経路に、次のアクションとなるノード（例: ユーザーへの応答を送信するSetノード、別のAI Agentノード、データ変換ノードなど）を接続します。
4. **後続のノードの構築:**
    
    - 各経路の要件に応じて、必要なデータ処理、AIエージェントへの再問い合わせ、外部APIとの連携などのノードを構築します。

---

## 5. まとめ

この解説で紹介した「アドバンスト出力」の概念、JSON形式の出力、コードノードによるパース、そしてif/switchノードによる動的な経路選択を組み合わせることで、n8nで非常に強力で柔軟なAIエージェントワークフローを構築できます。これにより、単一のテキスト応答だけでなく、エージェントの内部的な思考プロセスや信頼度、後続の処理に必要なメタデータなどを活用し、より洗練された自動化を実現することが可能になります。

これらのテクニックは、自己修正型エージェントや複雑な情報収集タスクなど、様々なユースケースに応用できます。ぜひご自身のワークフロー構築にお役立てください。

この説明は、あなたのn8nワークフロー構築の助けになりましたでしょうか？